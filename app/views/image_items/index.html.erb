<div class="boxed">
  <div class="container">
    <div class="tab">
      <span class="text-right" style="font-size:18px text-align:right;">
        <div class="dropdown-menus">
          <span class="dropdown">
            <button class="btn btn-default dropdown-toggle" data-toggle="dropdown">카테고리별</button>
              <div class="dropdown-menu">
                <% Category.all.each do |category| %>
                  <%= link_to category.title, image_items_path(category_id: category.id), class: "dropdown-item", remote: true %>
                <% end %>
              </div>
          </span>
          <span class="dropdown">
            <button class="btn btn-default dropdown-toggle" data-toggle="dropdown">타입별</button>
            <div class="dropdown-menu">
              <%= link_to "유료", image_items_path(type: "price >", order: "0"), class: "dropdown-item", remote: true %>
              <%= link_to "무료", image_items_path(type: "price is", order: "0"), class: "dropdown-item", remote: true %>
            </div>
          </span>
          <span class="dropdown">
            <button class="btn btn-default dropdown-toggle" data-toggle="dropdown">가격순</button>
            <div class="dropdown-menu">
              <%= link_to "높은순", image_items_path(type: "price", order: "desc"), class: "dropdown-item", remote: true %>
              <%= link_to "낮은순", image_items_path(type: "price", order: "asc"), class: "dropdown-item", remote: true %>
            </div>
          </span>
          <span class="dropdown">
            <button class="btn btn-default dropdown-toggle" data-toggle="dropdown">등록일</button>
            <div class="dropdown-menu">
              <%= link_to "최신순", image_items_path(type: "created_at", order: "desc"), class: "dropdown-item", remote: true %>
              <%= link_to "지난순", image_items_path(type: "created_at", order: "asc"), class: "dropdown-item", remote: true %>
            </div>
          </span>
        </div>
      </span>
    </div>
    <br/>
    <div id="image-item-list">
      <%= render partial: "image_items/image_items" %>
    </div>
    <div id="purchase-modal">
      <%= render partial: "image_items/purchase" %>
    </div>
  </div>
</div>

<script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>

<script type="text/javascript">
  
  $(".image_item_data").on("click", "#purchase_button", function(){
    $("#purchase_modal").show();
    $("#purchase-image").val($(this).data("itemtitle"));
    $("#purchase-imageid").val($(this).data("itemid"));
    $("#holding-amount").val("<%= current_user.chocomush %>")
    $("#purchase-amount").val($(this).data("itemprice"));
  })

  $("#close_button").on("click", function(){
    $("#purchase_modal").hide();
    $("#purchase-image").val('');
    $("#purchase-imageid").val('');
    $("#purchase-amount").val('');
  })

  $("#purchase_confirm_button").on("click", function(){
    var holdingAmount = $("#holding-amount").val();
    var purchaseAmount = $("#purchase-amount").val();
    purchaseAmount = parseInt(purchaseAmount);
    if(holdingAmount < purchaseAmount){
      alert("보유금액이 부족합니다.");
      var url = "/charge"
      $(location).attr('href', url);
    }else{
      $.ajax({
        type: "POST",
        url: "<%= orders_path %>",
        data: {chocomush: purchaseAmount,
               id: $("#purchase-imageid").val()},
        dataType: "json",
        beforeSend : function(xhr) {
          xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))
        },
        success: function (data) {
          console.log("success");
          $("#purchase_modal").hide();
          location.href = "/";
        },
        error : function(data){
          $("#search_error").show();
        }
      });
    }
  })
</script>
